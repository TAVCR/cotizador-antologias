<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Cotizaciones</title>
    <!-- Carga de Tailwind CSS para estilos modernos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de fuentes Montserrat y Merriweather desde Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados para usar las nuevas fuentes y mejorar la apariencia */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            margin-top: 2rem;
            overflow: hidden; /* Para contener los fondos de color */
        }
        h1 {
            font-family: 'Merriweather', serif;
            color: #1F2937;
            font-size: 2.25rem; 
            font-weight: 700;
            margin-bottom: 2rem;
            text-align: center;
        }
        .form-group {
            margin-bottom: 1.5rem;
            padding: 1.5rem 1rem;
        }
        /* Color de fondo intercalado para las secciones */
        .form-group:nth-of-type(odd) {
             background-color: #F0EAD6; /* Un color crema más fuerte */
             margin-left: -2.5rem;
             margin-right: -2.5rem;
             padding-left: 2.5rem;
             padding-right: 2.5rem;
             border-top: 1px solid #e5e7eb;
             border-bottom: 1px solid #e5e7eb;
        }
        .form-group:first-of-type {
            padding-top: 0;
            border-top: none;
            background-color: transparent;
            margin-left: 0;
            margin-right: 0;
            padding-left: 0;
            padding-right: 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }
        .category-label {
            font-family: 'Merriweather', serif;
            font-size: 1.25rem;
            font-weight: 700;
        }
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #1F2937;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="date"]:focus,
        .form-group input[type="number"]:focus,
        .form-group select:focus {
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
            outline: none;
        }
        .form-group-split {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: none;
            padding-top: 0;
        }
        .form-group-split > .form-group {
            flex: 1;
            margin-bottom: 0;
            border-top: none;
            padding: 0;
            background-color: transparent;
        }
        .time-input-group, .number-stepper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .time-input-group {
            gap: 0.25rem; /* Espacio reducido para el grupo de tiempo */
            flex-wrap: wrap; /* Permitir que los elementos se ajusten en pantallas pequeñas */
        }
        .time-input-group input, .number-stepper input {
            width: 60px;
            text-align: center;
            -moz-appearance: textfield;
        }
        .time-input-group .number-stepper input {
            width: 45px; /* Ancho reducido para los campos de hora/minuto */
        }
        .number-stepper input::-webkit-outer-spin-button,
        .number-stepper input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .stepper-btn {
            width: 2rem;
            height: 2rem;
            background-color: #e5e7eb;
            border-radius: 9999px;
            font-weight: bold;
            color: #4b5563;
            cursor: pointer;
        }
        .stepper-btn:hover {
            background-color: #d1d5db;
        }
        .time-input-group span {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4B5563;
        }
        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .radio-group input[type="radio"],
        .checkbox-group input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        .radio-group label,
        .checkbox-group label {
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .options-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .options-table th, .options-table td {
            padding: 0.75rem;
            border: 1px solid #E5E7EB;
            text-align: left;
            font-size: 0.95rem;
            color: #374151;
            vertical-align: top;
        }
        .options-table th {
            font-family: 'Merriweather', serif;
            background-color: #EFF6FF;
            font-weight: 700;
            color: #1F2937;
        }
        .options-table select, .options-table input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            font-size: 0.9rem;
        }
        .options-table .custom-option-input {
            margin-top: 0.5rem;
        }
        .options-table button {
            background-color: #EF4444;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .options-table button:hover {
            background-color: #DC2626;
        }
        .add-row-button {
            background-color: #22C55E;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            margin-top: 1rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .add-row-button:hover {
            background-color: #16A34A;
        }
        button[type="submit"] {
            background-color: #4F46E5;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            font-size: 1.125rem;
            font-weight: 700;
            width: 100%;
            margin-top: 2rem;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        button[type="submit"]:hover {
            background-color: #4338CA;
            transform: translateY(-2px);
        }
        .error-message {
            color: #EF4444;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: none;
        }
        .small-input {
            width: 80px;
            text-align: center;
        }
        .manage-options-button {
            background-color: #6b7280;
            color: white;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 9999px;
            margin-left: 1rem;
            vertical-align: middle;
        }
        .manage-options-button:hover {
            background-color: #4b5563;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
        }
        .modal-list {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        .modal-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .modal-list li:last-child {
            border-bottom: none;
        }
        .modal-list .edit-button {
            background-color: #3b82f6;
            margin-left: auto;
            margin-right: 0.5rem;
        }
        .modal-list .edit-button:hover {
            background-color: #2563eb;
        }
        .modal-list .save-button {
            background-color: #22c55e;
        }
        .modal-list .save-button:hover {
            background-color: #16a34a;
        }

        /* Responsividad para pantallas pequeñas */
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
                margin-top: 1rem;
            }
            h1 {
                font-size: 1.75rem;
                margin-bottom: 1.5rem;
            }
            .form-group-split {
                flex-direction: column;
                gap: 0;
            }
            .form-group-split > .form-group {
                margin-bottom: 1.5rem;
            }
            .form-group-split > .form-group:last-child {
                margin-bottom: 0;
            }
            .radio-group, .checkbox-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Generador de Cotizaciones</h1>
        <form id="cotizacion-form">
            <!-- Información del Cliente y Evento -->
            <div class="form-group">
                <label for="cliente">Nombre del Cliente:</label>
                <input type="text" id="cliente" required class="rounded-md">
                <div class="error-message" id="error-cliente">El nombre del cliente es obligatorio.</div>
            </div>
            <div class="form-group">
                <div class="form-group-split">
                    <div class="form-group">
                        <label for="fecha">Fecha del Evento:</label>
                        <input type="date" id="fecha" required class="rounded-md">
                        <div class="error-message" id="error-fecha">La fecha del evento es obligatoria.</div>
                    </div>
                    <div class="form-group">
                        <label for="hora">Hora del Evento:</label>
                        <div class="time-input-group">
                            <div class="number-stepper">
                                <button type="button" class="stepper-btn minus-btn">-</button>
                                <input type="text" id="hora-h" inputmode="numeric" pattern="[1-9]|1[0-2]" value="12" class="rounded-md">
                                <button type="button" class="stepper-btn plus-btn">+</button>
                            </div>
                            <span>:</span>
                            <div class="number-stepper">
                                <button type="button" class="stepper-btn minus-btn">-</button>
                                <input type="text" id="hora-m" inputmode="numeric" pattern="[0-5]?[0-9]" value="00" class="rounded-md">
                                <button type="button" class="stepper-btn plus-btn">+</button>
                            </div>
                            <select id="hora-ampm" class="rounded-md">
                                <option value="AM">AM</option>
                                <option value="PM">PM</option>
                            </select>
                        </div>
                        <div class="error-message" id="error-hora">La hora del evento es obligatoria.</div>
                    </div>
                </div>
            </div>

            <!-- Nuevo campo: Tipo de Evento -->
            <div class="form-group">
                <label for="tipo-evento" class="category-label">Tipo de Evento: <button type="button" class="manage-options-button" data-category="tipoEvento" data-title="Tipos de Evento">Administrar Opciones</button></label>
                <select id="tipo-evento" class="rounded-md" required>
                    <option value="">Seleccione el tipo de evento</option>
                    <option value="Otros">Otros</option>
                </select>
                <div class="error-message" id="error-tipo-evento">El tipo de evento es obligatorio.</div>
            </div>
            <div class="form-group" id="especificar-evento-group" style="display: none;">
                <label for="especificar-evento">Especificar Tipo de Evento:</label>
                <input type="text" id="especificar-evento" class="rounded-md">
                <div class="error-message" id="error-especificar-evento">Debe especificar el tipo de evento.</div>
            </div>

            <!-- Opciones a Incluir -->
            <div class="form-group">
                <label>Opciones a Incluir:</label>
                <div class="checkbox-group">
                    <input type="checkbox" id="incluir-entradas" checked class="form-checkbox text-primary rounded">
                    <label for="incluir-entradas">Entradas</label>
                    <input type="checkbox" id="incluir-postres" checked class="form-checkbox text-primary rounded">
                    <label for="incluir-postres">Postres</label>
                    <input type="checkbox" id="incluir-bebidas" checked class="form-checkbox text-primary rounded">
                    <label for="incluir-bebidas">Bebidas</label>
                </div>
            </div>

            <!-- Secciones de Opciones del Menú -->
            <div id="opciones-entradas-group" class="form-group">
                <label class="category-label">Entradas <button type="button" class="manage-options-button" data-category="entradas" data-title="Entradas">Administrar Opciones</button></label>
                <label for="cuantas-entradas">¿Cuántas entradas a elegir?</label>
                <div class="number-stepper">
                    <button type="button" class="stepper-btn minus-btn">-</button>
                    <input type="text" id="cuantas-entradas" inputmode="numeric" pattern="[1-9][0-9]*" value="1" class="small-input rounded-md">
                    <button type="button" class="stepper-btn plus-btn">+</button>
                </div>
                <table id="tabla-entradas" class="options-table">
                    <thead>
                        <tr>
                            <th>Descripción</th>
                            <th class="w-24"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="add-row-button" data-table="tabla-entradas">Agregar Nueva Opción</button>
                <div class="error-message" id="error-entradas">Debe agregar al menos una opción de entrada.</div>
            </div>

            <div class="form-group">
                <label class="category-label">Plato Fuerte (opciones excluyentes) <button type="button" class="manage-options-button" data-category="platoFuerte" data-title="Platos Fuertes">Administrar Opciones</button></label>
                <table id="tabla-plato-fuerte" class="options-table">
                    <thead>
                        <tr>
                            <th>Descripción</th>
                            <th class="w-24"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="add-row-button" data-table="tabla-plato-fuerte">Agregar Nueva Opción</button>
                <div class="error-message" id="error-plato-fuerte">Debe agregar al menos una opción de plato fuerte.</div>
            </div>

            <div id="opciones-postres-group" class="form-group">
                <label class="category-label">Postres (opciones excluyentes) <button type="button" class="manage-options-button" data-category="postres" data-title="Postres">Administrar Opciones</button></label>
                <table id="tabla-postres" class="options-table">
                    <thead>
                        <tr>
                            <th>Descripción</th>
                            <th class="w-24"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="add-row-button" data-table="tabla-postres">Agregar Nueva Opción</button>
                <div class="error-message" id="error-postres">Debe agregar al menos una opción de postre.</div>
            </div>

            <div id="opciones-bebidas-group" class="form-group">
                <label id="label-bebidas" class="category-label">Bebidas (elija cuántas y cuáles) <button type="button" class="manage-options-button" data-category="bebidas" data-title="Bebidas">Administrar Opciones</button></label>
                <label for="cuantas-bebidas">¿Cuántas bebidas a elegir?</label>
                <div class="number-stepper">
                     <button type="button" class="stepper-btn minus-btn">-</button>
                    <input type="text" id="cuantas-bebidas" inputmode="numeric" pattern="[1-9][0-9]*" value="1" class="small-input rounded-md">
                    <button type="button" class="stepper-btn plus-btn">+</button>
                </div>
                <table id="tabla-bebidas" class="options-table">
                    <thead>
                        <tr>
                            <th>Descripción</th>
                            <th class="w-24"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="add-row-button" data-table="tabla-bebidas">Agregar Nueva Opción</button>
                <div class="error-message" id="error-bebidas">Debe agregar al menos una opción de bebida.</div>
            </div>
            
            <div class="form-group">
                <label class="category-label">Menú para Niños (si aplica) <button type="button" class="manage-options-button" data-category="menuNinos" data-title="Menú para Niños">Administrar Opciones</button></label>
                <table id="tabla-menu-ninos" class="options-table">
                    <thead>
                        <tr>
                            <th>Descripción</th>
                            <th class="w-24"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="add-row-button" data-table="tabla-menu-ninos">Agregar Nueva Opción</button>
                <div class="error-message" id="error-menu-ninos">Debe agregar al menos una opción de menú para niños si hay niños.</div>
            </div>

            <!-- Invitados y Precios -->
            <div class="form-group">
                <label>Número de Invitados:</label>
                <div class="radio-group">
                    <input type="radio" id="definido" name="tipo-calculo" value="definido" checked class="form-radio text-primary rounded-full">
                    <label for="definido">Definido</label>
                    <input type="radio" id="indefinido" name="tipo-calculo" value="indefinido" class="form-radio text-primary rounded-full">
                    <label for="indefinido">Indefinido</label>
                </div>
            </div>

            <div id="numeros-definidos" class="form-group-split">
                <div class="form-group">
                    <label for="adultos">Número de Adultos:</label>
                     <div class="number-stepper">
                        <button type="button" class="stepper-btn minus-btn">-</button>
                        <input type="text" id="adultos" inputmode="numeric" pattern="[0-9]*" value="0" class="rounded-md">
                        <button type="button" class="stepper-btn plus-btn">+</button>
                    </div>
                    <div class="error-message" id="error-adultos">El número de adultos debe ser un entero no negativo.</div>
                </div>
                <div class="form-group">
                    <label for="ninos">Número de Niños:</label>
                    <div class="number-stepper">
                        <button type="button" class="stepper-btn minus-btn">-</button>
                        <input type="text" id="ninos" inputmode="numeric" pattern="[0-9]*" value="0" class="rounded-md">
                        <button type="button" class="stepper-btn plus-btn">+</button>
                    </div>
                    <div class="error-message" id="error-ninos">El número de niños debe ser un entero no negativo.</div>
                </div>
            </div>

            <div class="form-group-split">
                <div class="form-group">
                    <label for="precio-adulto">Precio por Adulto:</label>
                    <input type="number" id="precio-adulto" min="0" required class="rounded-md">
                    <div class="error-message" id="error-precio-adulto">El precio por adulto es obligatorio.</div>
                </div>
                <div class="form-group">
                    <label for="precio-nino">Precio por Niño:</label>
                    <input type="number" id="precio-nino" min="0" class="rounded-md">
                    <div class="error-message" id="error-precio-nino">El precio por niño es obligatorio si hay niños.</div>
                </div>
            </div>

            <div class="form-group-split">
                <div class="form-group">
                    <label>Moneda:</label>
                    <div class="radio-group">
                        <input type="radio" id="moneda-crc" name="moneda" value="CRC" checked class="form-radio text-primary rounded-full">
                        <label for="moneda-crc">Colones (₡)</label>
                        <input type="radio" id="moneda-usd" name="moneda" value="USD" class="form-radio text-primary rounded-full">
                        <label for="moneda-usd">Dólares ($)</label>
                    </div>
                </div>
                <div class="form-group" id="tipo-cambio-group" style="display: none;">
                    <label for="tipo-cambio">Tipo de Cambio (₡ a $):</label>
                    <input type="number" id="tipo-cambio" min="0" step="0.01" class="rounded-md">
                    <div class="error-message" id="error-tipo-cambio">El tipo de cambio es obligatorio para cotizar en dólares.</div>
                </div>
            </div>

            <div class="form-group">
                <label for="font-size-adjust">Ajustar Tamaño de Fuente del PDF: <span id="font-size-value">100%</span></label>
                <input type="range" id="font-size-adjust" min="70" max="130" value="100" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>

            <div class="error-message" id="error-no-menu-selected" style="text-align: center;">Debe seleccionar y agregar al menos una opción en alguna de las categorías de menú (Entradas, Plato Fuerte, Postres, Bebidas).</div>
            <button type="submit">Generar Cotización en PDF</button>
        </form>
    </div>

    <!-- Modal para administrar opciones -->
    <div id="options-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-4" style="font-family: 'Merriweather', serif;"></h2>
            <ul id="modal-list" class="modal-list"></ul>
            <div class="mt-4 flex gap-2">
                <input type="text" id="modal-new-option" class="flex-grow p-2 border rounded-md" placeholder="Nueva opción...">
                <button type="button" id="modal-add-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold w-10 h-10 flex items-center justify-center rounded-md text-2xl">+</button>
            </div>
            <button type="button" id="modal-close-button" class="mt-4 bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md w-full">Cerrar</button>
        </div>
    </div>

    <!-- Carga de las librerías jsPDF y jspdf-autotable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Asegúrate de que jspdf y jspdf-autotable estén disponibles globalmente
        const { jsPDF } = window.jspdf;

        // Colores personalizados
        const titleColor = [100, 50, 30];
        const headerBgColor = [50, 30, 20];
        const headerTextColor = [255, 255, 255];
        const bodyCellFillColor = [250, 245, 235];

        // Opciones predefinidas para los menús
        let predefinedOptions = {
            tipoEvento: ['Desayuno', 'Almuerzo', 'Cena', 'Café', 'Cumpleaños', 'Boda', 'Actividad Corporativa', 'Despedida de Soltero', 'Fiesta de Bautizo', 'Fiesta de Revelación de Género', 'Aniversario de Bodas', 'Fiesta de Despedida', 'Fiesta de Bienvenida', 'Fiesta de Empresa', 'Fiesta de Quince Años', 'Fiesta de Graduación', 'Degustaciones Privadas', 'Evento Exclusivo', 'Baby Shower', 'Cena de Gala Corporativa', 'Capacitación', 'Lanzamiento de Producto', 'Renovación de Votos', 'Reunión de Alumnos', 'Propuesta de Matrimonio'],
            entradas: ['Ceviche de Pescado', 'Ceviche de Palmito y Pejibaye', 'Taquitos de la Casa', 'Sopa de Mariscos', 'Crema de pejibaye', 'Cóctel de Mejillones con ceviche', 'Sopa Azteca', 'Ensalada Antologías', 'Mejillones al ajillo', 'Patacones con Frijoles Molidos y Queso', 'Patacón con Ceviche', 'Canastas de Patacón', 'Mozzarella Sticks', 'Ensalada Capresse'],
            platoFuerte: ['Lomito en Salsa de Hongos con Arroz y Vegetales', 'Pollo a la Naranja con Arroz y Yuca al Mojo', 'Pollo a la Mernier con Vegetales y Papitas Salteadas', 'Salmón Antologías con Yuca al Mojo y Ensalada o Vegetales', 'Pechuga a la Parmesana con arroz y ensalada', 'Pechuga al la plancha con Arroz y Vegetales', 'Corvina a la Plancha con Puré de Papa', 'Filet de Pescado Con Salsa De Mariscos, Arroz y Vegetales', 'Pechuga en Salsa Hawaiana con Arroz y Vegetales', 'Camarones a La Caribeña con Arroz y Vegetales', 'Salmón Asiático con Arroz y Vegetales', 'Mariscada al Gusto con Arroz y Vegetales', 'Arroz con Mariscos, Papas Fritas y Ensalada', 'Arroz Antologías Papas Fritas y Ensalada', 'Arroz con Camarones, Papas Fritas y Ensalada', 'Herman Burger con Papas Fritas', 'Hamburguesa Antologías con Papas Fritas', 'Hamburguesa Sargento Pimienta, Papas Fritas y Ensalada', 'Pasta con Lomito y Pan de Ajo', 'Pasta con Pollo y Pan de Ajo', 'Pasta con Camarones y Pan de Ajo', 'Pasta en Salsa de Mariscos y Pan de Ajo', 'Pasta Thai y Pan de Ajo'],
            postres: ['Flan de Coco', 'Flan de Caramelo', 'Cheese Cake de Fresa', 'Pie de Limón', 'Torta Chilena'],
            bebidas: ['Refresco Natural', 'Refresco Gaseoso', 'Cerveza', 'Trago de la Casa', 'Copa de Vino', 'Copa de Sangría', 'Shot de Whisky y Liga', 'Shot de Ron y Liga', 'Mojito', 'Café Americano', 'Café Capuccino', 'Chocolate Caliente', 'Café Antologías', 'Café con Leche', 'Té Caliente', 'Té Frío'],
            menuNinos: ['Nuggets de Pollo', 'Hamburguesa para Niños', 'Dedos de Pescado', 'Spaguetti']
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Cargar opciones desde localStorage
            const savedOptions = localStorage.getItem('cotizacionPredefinedOptions');
            if (savedOptions) {
                predefinedOptions = JSON.parse(savedOptions);
            }

            // Referencias a elementos del DOM
            const form = document.getElementById('cotizacion-form');
            const incluirEntradasCheckbox = document.getElementById('incluir-entradas');
            const incluirPostresCheckbox = document.getElementById('incluir-postres');
            const incluirBebidasCheckbox = document.getElementById('incluir-bebidas');
            const fontSizeSlider = document.getElementById('font-size-adjust');
            const fontSizeValueSpan = document.getElementById('font-size-value');
            const modal = document.getElementById('options-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalList = document.getElementById('modal-list');
            const modalNewOptionInput = document.getElementById('modal-new-option');
            const modalAddButton = document.getElementById('modal-add-button');
            const modalCloseButton = document.getElementById('modal-close-button');
            let currentCategory = '';

            fontSizeSlider.addEventListener('input', function() {
                fontSizeValueSpan.textContent = `${this.value}%`;
            });

            function toggleMenuSections() {
                document.getElementById('opciones-entradas-group').style.display = incluirEntradasCheckbox.checked ? 'block' : 'none';
                document.getElementById('opciones-postres-group').style.display = incluirPostresCheckbox.checked ? 'block' : 'none';
                document.getElementById('opciones-bebidas-group').style.display = incluirBebidasCheckbox.checked ? 'block' : 'none';
            }

            function addRow(tableId) {
                const tableBody = document.getElementById(tableId).querySelector('tbody');
                const newRow = tableBody.insertRow();
                const cell = newRow.insertCell(0);
                const deleteCell = newRow.insertCell(1);

                let optionsKey;
                switch (tableId) {
                    case 'tabla-entradas': optionsKey = 'entradas'; break;
                    case 'tabla-plato-fuerte': optionsKey = 'platoFuerte'; break;
                    case 'tabla-postres': optionsKey = 'postres'; break;
                    case 'tabla-bebidas': optionsKey = 'bebidas'; break;
                    case 'tabla-menu-ninos': optionsKey = 'menuNinos'; break;
                }
                const options = predefinedOptions[optionsKey];

                const select = document.createElement('select');
                select.className = 'w-full p-2 border rounded-md';
                
                select.innerHTML = `<option value="" disabled selected>Seleccione una opción...</option>`;
                options.forEach(opt => select.innerHTML += `<option value="${opt}">${opt}</option>`);
                select.innerHTML += `<option value="custom">Otra opción (especificar)...</option>`;
                
                cell.appendChild(select);

                select.addEventListener('change', (e) => {
                    let existingInput = cell.querySelector('.custom-option-input');
                    if (existingInput) existingInput.remove();
                    if (e.target.value === 'custom') {
                        const customInput = document.createElement('input');
                        customInput.type = 'text';
                        customInput.placeholder = 'Escriba la opción personalizada';
                        customInput.className = 'custom-option-input mt-2 w-full p-2 border rounded-md';
                        cell.appendChild(customInput);
                    }
                });

                deleteCell.innerHTML = `<button type="button" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md delete-row-button">X</button>`;
                deleteCell.querySelector('.delete-row-button').addEventListener('click', () => newRow.remove());
            }

            function initializeTables() {
                ['tabla-entradas', 'tabla-plato-fuerte', 'tabla-postres', 'tabla-bebidas', 'tabla-menu-ninos'].forEach(addRow);
            }

            document.querySelectorAll('.add-row-button').forEach(button => {
                button.addEventListener('click', function() {
                    addRow(this.dataset.table);
                });
            });

            // --- INICIO LÓGICA DE MODAL ---
            function saveOptionsToLocalStorage() {
                localStorage.setItem('cotizacionPredefinedOptions', JSON.stringify(predefinedOptions));
            }

            function populateModal(category, title) {
                currentCategory = category;
                modalTitle.textContent = `Administrar ${title}`;
                modalList.innerHTML = '';
                predefinedOptions[category].forEach((option, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${option}</span>`;

                    const btnContainer = document.createElement('div');

                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Editar';
                    editBtn.className = 'edit-button bg-blue-500 text-white px-2 py-1 rounded-md text-xs';
                    editBtn.onclick = () => {
                        const span = li.querySelector('span');
                        const currentText = span.textContent;
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = currentText;
                        input.className = 'flex-grow p-1 border rounded-md';
                        
                        const saveBtn = document.createElement('button');
                        saveBtn.textContent = 'Guardar';
                        saveBtn.className = 'save-button bg-green-500 text-white px-2 py-1 rounded-md text-xs ml-2';
                        saveBtn.onclick = () => {
                            const newText = input.value.trim();
                            if (newText) {
                                predefinedOptions[category][index] = newText;
                                saveOptionsToLocalStorage();
                                populateModal(category, title);
                                updateAllSelects();
                            }
                        };
                        
                        li.innerHTML = '';
                        li.appendChild(input);
                        li.appendChild(saveBtn);
                    };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Eliminar';
                    deleteBtn.className = 'bg-red-500 text-white px-2 py-1 rounded-md text-xs ml-2';
                    deleteBtn.onclick = () => {
                        predefinedOptions[category].splice(index, 1);
                        saveOptionsToLocalStorage();
                        populateModal(category, title);
                        updateAllSelects();
                    };

                    btnContainer.appendChild(editBtn);
                    btnContainer.appendChild(deleteBtn);
                    li.appendChild(btnContainer);
                    modalList.appendChild(li);
                });
                modal.style.display = 'flex';
            }

            modalAddButton.onclick = () => {
                const newOption = modalNewOptionInput.value.trim();
                if (newOption && !predefinedOptions[currentCategory].includes(newOption)) {
                    predefinedOptions[currentCategory].push(newOption);
                    saveOptionsToLocalStorage();
                    populateModal(currentCategory, modalTitle.textContent.replace('Administrar ', ''));
                    updateAllSelects();
                    modalNewOptionInput.value = '';
                }
            };

            modalCloseButton.onclick = () => {
                modal.style.display = 'none';
            };

            document.querySelectorAll('.manage-options-button').forEach(button => {
                button.addEventListener('click', function() {
                    const category = this.dataset.category;
                    const title = this.dataset.title;
                    populateModal(category, title);
                });
            });

            function updateAllSelects() {
                document.querySelectorAll('select').forEach(select => {
                    // Actualizar selects de tablas de menú
                    const table = select.closest('.options-table');
                    if (table) {
                        const tableId = table.id;
                        let optionsKey;
                         switch (tableId) {
                            case 'tabla-entradas': optionsKey = 'entradas'; break;
                            case 'tabla-plato-fuerte': optionsKey = 'platoFuerte'; break;
                            case 'tabla-postres': optionsKey = 'postres'; break;
                            case 'tabla-bebidas': optionsKey = 'bebidas'; break;
                            case 'tabla-menu-ninos': optionsKey = 'menuNinos'; break;
                        }
                        if (optionsKey) {
                            const currentVal = select.value;
                            const options = predefinedOptions[optionsKey];
                            select.innerHTML = `<option value="" disabled>Seleccione una opción...</option>`;
                            options.forEach(opt => select.innerHTML += `<option value="${opt}">${opt}</option>`);
                            select.innerHTML += `<option value="custom">Otra opción (especificar)...</option>`;
                            if (options.includes(currentVal) || currentVal === 'custom') {
                                select.value = currentVal;
                            } else {
                                select.value = "";
                            }
                        }
                    }
                    // Actualizar select de tipo de evento
                    if (select.id === 'tipo-evento') {
                        const currentVal = select.value;
                        const options = predefinedOptions.tipoEvento;
                        select.innerHTML = `<option value="">Seleccione el tipo de evento</option>`;
                        options.forEach(opt => select.innerHTML += `<option value="${opt}">${opt}</option>`);
                        select.innerHTML += `<option value="Otros">Otros</option>`;
                        if (options.includes(currentVal) || currentVal === 'Otros') {
                            select.value = currentVal;
                        } else {
                            select.value = "";
                        }
                    }
                });
            }
            // --- FIN LÓGICA DE MODAL ---

            // --- INICIO LÓGICA DE STEPPERS ---
            document.querySelectorAll('.number-stepper').forEach(stepper => {
                const input = stepper.querySelector('input[type="text"]');
                const minusBtn = stepper.querySelector('.minus-btn');
                const plusBtn = stepper.querySelector('.plus-btn');

                minusBtn.addEventListener('click', () => {
                    let currentValue = parseInt(input.value, 10);
                    if (isNaN(currentValue)) currentValue = 0;

                    let min = (input.id === 'cuantas-entradas' || input.id === 'cuantas-bebidas' || input.id === 'hora-h') ? 1 : 0;
                    
                    if (input.id === 'hora-h') {
                        currentValue = currentValue === 1 ? 12 : currentValue - 1;
                    } else if (input.id === 'hora-m') {
                        currentValue = currentValue === 0 ? 59 : currentValue - 1;
                    } else {
                        currentValue = Math.max(min, currentValue - 1);
                    }

                    input.value = input.id === 'hora-m' ? currentValue.toString().padStart(2, '0') : currentValue;
                });

                plusBtn.addEventListener('click', () => {
                    let currentValue = parseInt(input.value, 10);
                    if (isNaN(currentValue)) currentValue = 0;
                    
                    if (input.id === 'hora-h') {
                        currentValue = currentValue === 12 ? 1 : currentValue + 1;
                    } else if (input.id === 'hora-m') {
                        currentValue = currentValue === 59 ? 0 : currentValue + 1;
                    } else {
                        currentValue++;
                    }
                    
                    input.value = input.id === 'hora-m' ? currentValue.toString().padStart(2, '0') : currentValue;
                });
            });
            // --- FIN LÓGICA DE STEPPERS ---


            incluirEntradasCheckbox.addEventListener('change', toggleMenuSections);
            incluirPostresCheckbox.addEventListener('change', toggleMenuSections);
            incluirBebidasCheckbox.addEventListener('change', toggleMenuSections);
            
            toggleMenuSections();
            initializeTables();
            updateAllSelects(); // Para poblar el select de tipo de evento inicialmente
            
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                if (validateForm()) {
                    generatePDF();
                }
            });

            function showError(id, message) {
                const errorElement = document.getElementById(id);
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }

            function hideError(id) {
                document.getElementById(id).style.display = 'none';
            }

            function validateForm() {
                let isValid = true;
                document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

                // Validar campos de texto y fecha
                const requiredFields = ['cliente', 'fecha', 'hora-h', 'hora-m', 'tipo-evento', 'precio-adulto'];
                requiredFields.forEach(id => {
                    const input = document.getElementById(id);
                    if (!input.value.trim()) {
                        isValid = false;
                        showError(`error-${id.split('-')[0]}`, 'Este campo es obligatorio.');
                    }
                });

                // Validar números positivos
                const numberFields = [
                    { id: 'adultos', errorId: 'error-adultos', message: 'El número de adultos debe ser un entero no negativo.' },
                    { id: 'ninos', errorId: 'error-ninos', message: 'El número de niños debe ser un entero no negativo.' }
                ];
                numberFields.forEach(field => {
                    const input = document.getElementById(field.id);
                    const value = parseFloat(input.value);
                    if (input.value.trim() !== '' && (value < 0 || !Number.isInteger(value))) {
                        isValid = false;
                        showError(field.errorId, field.message);
                    }
                });
                
                const adultosVal = parseInt(document.getElementById('adultos').value) || 0;
                const ninosVal = parseInt(document.getElementById('ninos').value) || 0;

                if (adultosVal === 0 && ninosVal === 0) {
                    isValid = false;
                    showError('error-adultos', 'Debe haber al menos un adulto o un niño.');
                }

                // Validar selecciones de menú
                const validateMenuTable = (tableId, errorId, isChecked, minRows = 1) => {
                    if (!isChecked) return true;
                    const rows = document.querySelectorAll(`#${tableId} tbody tr`);
                    if (rows.length < minRows) {
                        showError(errorId, `Debe agregar al menos ${minRows} opción(es).`);
                        return false;
                    }
                    let allSelected = true;
                    rows.forEach(row => {
                        const select = row.querySelector('select');
                        if (!select || !select.value) {
                            allSelected = false;
                        } else if (select.value === 'custom') {
                            const customInput = row.querySelector('.custom-option-input');
                            if (!customInput || !customInput.value.trim()) {
                                allSelected = false;
                            }
                        }
                    });
                    if (!allSelected) {
                        showError(errorId, 'Por favor, seleccione o especifique una opción en cada fila.');
                        return false;
                    }
                    return true;
                };

                if (!validateMenuTable('tabla-entradas', 'error-entradas', incluirEntradasCheckbox.checked)) isValid = false;
                if (!validateMenuTable('tabla-plato-fuerte', 'error-plato-fuerte', true, 1)) isValid = false;
                if (!validateMenuTable('tabla-postres', 'error-postres', incluirPostresCheckbox.checked)) isValid = false;
                if (!validateMenuTable('tabla-bebidas', 'error-bebidas', incluirBebidasCheckbox.checked)) isValid = false;

                if (ninosVal > 0) {
                    if (!validateMenuTable('tabla-menu-ninos', 'error-menu-ninos', true, 1)) isValid = false;
                }

                return isValid;
            }

            function getTableData(tableId) {
                const tableBody = document.getElementById(tableId).querySelector('tbody');
                const rows = tableBody.querySelectorAll('tr');
                const data = [];
                rows.forEach(row => {
                    const select = row.querySelector('select');
                    if (select && select.value) {
                        if (select.value === 'custom') {
                            const customInput = row.querySelector('.custom-option-input');
                            if (customInput && customInput.value.trim() !== '') {
                                data.push([customInput.value.trim()]);
                            }
                        } else {
                            data.push([select.value]);
                        }
                    }
                });
                return data;
            }

            async function generatePDF() {
                const doc = new jsPDF();
                const baseMultiplier = 1.37;
                const sliderMultiplier = parseInt(fontSizeSlider.value) / 100;
                const fontMultiplier = baseMultiplier * sliderMultiplier;

                const colonesSymbolUrl = 'https://i.postimg.cc/1zsn6BQ2/simbolo-de-moneda-colon-de-costa-rica.png';
                let colonesSymbolBase64 = '';
                try {
                    const response = await fetch(colonesSymbolUrl);
                    const blob = await response.blob();
                    const reader = new FileReader();
                    await new Promise(resolve => {
                        reader.onloadend = () => { colonesSymbolBase64 = reader.result; resolve(); };
                        reader.readAsDataURL(blob);
                    });
                } catch (error) { console.error("Error al cargar el símbolo de colones:", error); }

                const imageUrl = 'https://i.postimg.cc/xjNqbdqD/ANTO-SALON.png';
                let imgHeight = 0;
                try {
                    const response = await fetch(imageUrl);
                    const blob = await response.blob();
                    const reader = new FileReader();
                     await new Promise(resolve => {
                        reader.onloadend = () => {
                            const base64Image = reader.result;
                            const imgWidth = 180;
                            imgHeight = (imgWidth / 1920) * 1080;
                            const xPos = (doc.internal.pageSize.width - imgWidth) / 2;
                            doc.addImage(base64Image, 'PNG', xPos, 10, imgWidth, imgHeight);
                            resolve();
                        };
                        reader.readAsDataURL(blob);
                    });
                } catch (error) { console.error("Error al cargar la imagen principal:", error); }

                let yOffset = 10 + imgHeight + 15;

                const cliente = document.getElementById('cliente').value;
                const adultos = parseInt(document.getElementById('adultos').value) || 0;
                const ninos = parseInt(document.getElementById('ninos').value) || 0;
                const fecha = document.getElementById('fecha').value;
                const fechaObj = new Date(fecha + 'T00:00:00');
                const fechaFormateada = fechaObj.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const horaH = document.getElementById('hora-h').value;
                const horaM = document.getElementById('hora-m').value;
                const horaAMPM = document.getElementById('hora-ampm').value;
                const horaFormateada = `${horaH}:${horaM} ${horaAMPM}`;
                let tipoDeEventoParaSaludo = document.getElementById('tipo-evento').value === 'Otros' ? document.getElementById('especificar-evento').value.trim() : document.getElementById('tipo-evento').value;

                doc.setFont("Times-Roman", "bold").setFontSize(20 * fontMultiplier);
                doc.setTextColor(titleColor[0], titleColor[1], titleColor[2]);
                doc.text("Saludos Cordiales", 20, yOffset);
                yOffset += doc.getTextDimensions("Saludos Cordiales").h + 5 * fontMultiplier;

                doc.setFont("Helvetica", "normal");
                doc.setFontSize(14 * fontMultiplier);
                doc.setTextColor(70, 70, 70);
                
                const introText1 = `Estimado ${cliente}: Nos complace presentarle nuestra cotización detallada para su ${tipoDeEventoParaSaludo}. Esta propuesta ha sido cuidadosamente preparada para ${adultos} adulto(s) y ${ninos} niño(s) que se llevará a cabo el ${fechaFormateada} a las ${horaFormateada}. Esperamos que sea de su agrado.`;
                doc.text(introText1, 20, yOffset, { maxWidth: doc.internal.pageSize.width - 40, align: 'justify' });
                yOffset += doc.getTextDimensions(introText1, { maxWidth: doc.internal.pageSize.width - 40 }).h + (4 * fontMultiplier);

                const introText2 = `Para cualquier consulta adicional o para confirmar, no dude en contactarnos al 8830-7837. Estamos a su entera disposición.`;
                doc.text(introText2, 20, yOffset, { maxWidth: doc.internal.pageSize.width - 40, align: 'justify' });
                yOffset += doc.getTextDimensions(introText2, { maxWidth: doc.internal.pageSize.width - 40 }).h + 15;

                const addMenuSection = (title, tableId, optionsText = null) => {
                    const data = getTableData(tableId);
                    if (data.length > 0) {
                        // --- INICIO DE LÓGICA DEPURADA ---
                        const tempDoc = new jsPDF();
                        let tableHeight;
                        tempDoc.autoTable({
                            head: [['Descripción']],
                            body: data,
                            startY: 0,
                            styles: { fontSize: 14 * fontMultiplier, cellPadding: 4 * fontMultiplier, font: "Helvetica" },
                            headStyles: { fontSize: 16 * fontMultiplier, font: "Times-Roman", fontStyle: 'bold' },
                            margin: { left: 20, right: 20 },
                            theme: 'striped',
                        });
                        tableHeight = tempDoc.autoTable.previous.finalY;

                        let textHeight = 0;
                        doc.setFont("Times-Roman", "bold").setFontSize(20 * fontMultiplier);
                        textHeight += doc.getTextDimensions(title).h + (10 * fontMultiplier);
                        if (optionsText) {
                            doc.setFont("Helvetica", "normal").setFontSize(14 * fontMultiplier);
                            textHeight += doc.getTextDimensions(optionsText).h + (3.5 * fontMultiplier); // Espacio reducido
                        }

                        const sectionHeight = textHeight + tableHeight + 15 * fontMultiplier;
                        const pageHeight = doc.internal.pageSize.height;
                        const bottomMargin = 20;

                        if (yOffset + sectionHeight > pageHeight - bottomMargin) {
                            doc.addPage();
                            yOffset = 20;
                        }
                        // --- FIN DE LÓGICA DEPURADA ---

                        doc.setFont("Times-Roman", "bold");
                        doc.setFontSize(20 * fontMultiplier);
                        doc.setTextColor(titleColor[0], titleColor[1], titleColor[2]);
                        doc.text(title, 20, yOffset);
                        yOffset += doc.getTextDimensions(title).h + 2 * fontMultiplier;

                        if (optionsText) {
                            doc.setFont("Helvetica", "normal");
                            doc.setFontSize(14 * fontMultiplier);
                            doc.setTextColor(100, 100, 100);
                            doc.text(optionsText, 20, yOffset);
                            yOffset += doc.getTextDimensions(optionsText).h + 2 * fontMultiplier;
                        }
                        yOffset += 2.5 * fontMultiplier; // Espacio reducido

                        doc.autoTable({
                            startY: yOffset,
                            head: [['Descripción']],
                            body: data,
                            theme: 'striped',
                            styles: {
                                fontSize: 14 * fontMultiplier,
                                cellPadding: 4 * fontMultiplier,
                                fillColor: bodyCellFillColor,
                                textColor: [50, 50, 50],
                                lineColor: [220, 220, 220],
                                lineWidth: 0.1,
                                font: "Helvetica",
                                fontStyle: "normal"
                            },
                            headStyles: {
                                fillColor: headerBgColor,
                                textColor: headerTextColor,
                                fontStyle: 'bold',
                                fontSize: 16 * fontMultiplier,
                                font: "Times-Roman"
                            },
                            margin: { left: 20, right: 20 },
                        });
                        yOffset = doc.autoTable.previous.finalY + 15 * fontMultiplier;
                    }
                };
                
                if (incluirEntradasCheckbox.checked) addMenuSection('Entradas', 'tabla-entradas', `(Elija ${document.getElementById('cuantas-entradas').value} opción(es))`);
                addMenuSection('Plato Fuerte', 'tabla-plato-fuerte', '(Elija una Opción)');
                if (incluirPostresCheckbox.checked) addMenuSection('Postres', 'tabla-postres', '(Elija una Opción)');
                if (incluirBebidasCheckbox.checked) addMenuSection('Bebidas', 'tabla-bebidas', `(Elija ${document.getElementById('cuantas-bebidas').value} bebidas)`);
                if (ninos > 0 && getTableData('tabla-menu-ninos').length > 0) addMenuSection('Menú para Niños', 'tabla-menu-ninos', '(Elija una Opción - Incluye una bebida y un postre)');


                doc.addPage();
                yOffset = 20;

                doc.setFont("Times-Roman", "bold");
                doc.setFontSize(20 * fontMultiplier);
                doc.setTextColor(titleColor[0], titleColor[1], titleColor[2]);
                doc.text("Resumen de Invitados y Precios", 20, yOffset);
                yOffset += 10 * fontMultiplier;

                const precioAdulto = parseFloat(document.getElementById('precio-adulto').value) || 0;
                const precioNino = parseFloat(document.getElementById('precio-nino').value) || 0;
                const moneda = document.querySelector('input[name="moneda"]:checked').value;
                const tipoCambio = parseFloat(document.getElementById('tipo-cambio').value) || 1;

                let totalAdultos = adultos * precioAdulto;
                let totalNinos = ninos * precioNino;
                let subtotal = totalAdultos + totalNinos;
                const impuestoVentas = subtotal * 0.10;
                const impuestoServicio = subtotal * 0.13;
                let totalFinal = subtotal + impuestoVentas + impuestoServicio;

                const formatCurrency = (value) => {
                    const finalValue = moneda === 'USD' ? value / tipoCambio : value;
                    const locale = moneda === 'CRC' ? 'es-CR' : 'en-US';
                    const formattedValue = finalValue.toLocaleString(locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    if (moneda === 'CRC') return { type: 'CRC_IMAGE', value: formattedValue };
                    return `$ ${formattedValue}`;
                };

                const summaryData = [['Número de Adultos:', adultos], ['Precio por Adulto:', formatCurrency(precioAdulto)], ['Total Adultos:', formatCurrency(totalAdultos)]];
                if (ninos > 0) summaryData.push(['Número de Niños:', ninos], ['Precio por Niño:', formatCurrency(precioNino)], ['Total Niños:', formatCurrency(totalNinos)]);
                summaryData.push(['Subtotal:', formatCurrency(subtotal)], ['Impuesto de Ventas (10%):', formatCurrency(impuestoVentas)], ['Impuesto de Servicio (13%):', formatCurrency(impuestoServicio)], ['TOTAL FINAL:', formatCurrency(totalFinal)]);

                doc.autoTable({
                    startY: yOffset,
                    body: summaryData,
                    theme: 'grid',
                    styles: {
                        fontSize: 14 * fontMultiplier,
                        cellPadding: 4 * fontMultiplier,
                        textColor: [50, 50, 50],
                        lineColor: [220, 220, 220],
                        lineWidth: 0.1,
                        font: "Helvetica",
                        fontStyle: "normal"
                    },
                    columnStyles: {
                        0: { font: 'Times-Roman', fontStyle: 'bold', fillColor: [245, 245, 245], cellWidth: 80 },
                        1: { halign: 'left', cellWidth: 'auto' }
                    },
                    bodyStyles: { fillColor: bodyCellFillColor },
                    margin: { left: 20, right: 20 },
                    didParseCell: (data) => {
                        if (data.row.index === summaryData.length - 1) {
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fontSize = (14 * fontMultiplier) * 1.25;
                        }
                        if (data.column.index === 1 && typeof data.cell.raw === 'object' && data.cell.raw.type === 'CRC_IMAGE') {
                            data.cell.text = '';
                            data.cell.colonesValue = data.cell.raw.value;
                            data.cell.isColonesImage = true;
                        }
                    },
                    didDrawCell: (data) => {
                        if (data.column.index === 1 && data.cell.isColonesImage && colonesSymbolBase64) {
                            let imgSize = 5 * fontMultiplier;
                             if (data.row.index === summaryData.length - 1) {
                                imgSize *= 1.25;
                            }
                            const textPadding = 2;
                            const imgX = data.cell.x + data.cell.padding('left');
                            const imgY = data.cell.y + (data.cell.height - imgSize) / 2;
                            doc.addImage(colonesSymbolBase64, 'PNG', imgX, imgY, imgSize, imgSize);
                            doc.setFontSize(data.cell.styles.fontSize);
                            doc.setTextColor(...data.cell.styles.textColor);
                            doc.setFont(data.cell.styles.font, data.cell.styles.fontStyle);
                            doc.text(data.cell.colonesValue, imgX + imgSize + textPadding, data.cell.y + data.cell.height / 2, { align: 'left', baseline: 'middle' });
                        }
                    }
                });
                yOffset = doc.autoTable.previous.finalY + 15;

                doc.setFont("Helvetica", "normal");
                doc.setFontSize(12); // Tamaño de fuente fijo para las notas
                doc.setTextColor(100, 100, 100);
                doc.text("Notas: Esta cotización es válida por 30 días. Precios sujetos a cambios.", 20, yOffset);

                doc.save(`Cotización ${cliente}.pdf`);
            }
        });
    </script>
</body>
</html>
